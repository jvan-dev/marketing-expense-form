<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Submit Marketing Expense</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #f5f5f5;
    }

    .wrapper {
      max-width: 720px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 12px;
      padding: 24px 20px 28px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.06);
    }

    h1 {
      margin: 0 0 8px;
      font-size: 22px;
    }

    p.description {
      margin: 0 0 16px;
      color: #555;
      font-size: 14px;
    }

    .note {
      background: #f0f4ff;
      border-radius: 8px;
      padding: 10px 12px;
      margin-bottom: 16px;
      font-size: 13px;
      color: #334;
    }

    .search-block {
      margin-bottom: 20px;
    }

    .search-block h2 {
      margin: 0 0 6px;
      font-size: 16px;
    }

    .search-block small {
      color: #666;
      font-size: 12px;
    }

    .search-input {
      width: 100%;
      padding: 8px;
      margin-top: 6px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 14px;
      box-sizing: border-box;
    }

    .results-list {
      list-style: none;
      padding-left: 0;
      margin: 6px 0 0;
      border: 1px solid #ccc;
      max-height: 180px;
      overflow-y: auto;
      background: #fff;
      border-radius: 4px;
    }

    .results-list li {
      padding: 6px 8px;
      cursor: pointer;
      font-size: 14px;
    }

    .results-list li:hover {
      background: #f0f4ff;
    }

    .selected-chips {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      padding: 4px 8px;
      border-radius: 12px;
      background: #eef2ff;
      font-size: 12px;
      gap: 6px;
    }

    .chip button {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 12px;
      line-height: 1;
    }
  </style>

  <!-- HubSpot forms v2 JS (inline embed) -->
  <script charset="utf-8" type="text/javascript" src="//js.hsforms.net/forms/embed/v2.js"></script>
</head>
<body>
  <div class="wrapper">
    <h1>Submit Marketing Expense</h1>
    <p class="description">
      Use this form to log your marketing expenses and upload a receipt.
      After submission, your expense will appear in the Marketing Expenses pipeline.
    </p>

    <div class="note">
      <strong>Tip:</strong> Use the search boxes below to select the company or companies this
      expense should be attributed to, and (optionally) a contact. The form will automatically
      update the hidden HubSpot fields and your workflow will handle the rest.
    </div>

    <!-- Custom search UI ABOVE the HubSpot form -->
    <div id="custom-search-blocks">
      <div class="search-block">
        <h2>Select Companies</h2>
        <small>
          Start typing and choose each company this expense should be split across.
          You can select multiple companies.
        </small>
        <input
          type="text"
          id="company-search"
          class="search-input"
          placeholder="Start typing company name..."
          autocomplete="off"
        />
        <ul id="company-results" class="results-list"></ul>
        <div id="company-selected" class="selected-chips"></div>
      </div>

      <div class="search-block">
        <h2>Select Contact (optional)</h2>
        <small>
          Start typing and select the contact (e.g. attorney, office contact, or patient).
        </small>
        <input
          type="text"
          id="contact-search"
          class="search-input"
          placeholder="Start typing contact name or email..."
          autocomplete="off"
        />
        <ul id="contact-results" class="results-list"></ul>
      </div>
    </div>

    <!-- Container where HubSpot form will render inline -->
    <div id="hs-form-container"></div>
  </div>

  <script>
    // Render the HubSpot form inline (no iframe)
    document.addEventListener("DOMContentLoaded", function () {
      if (window.hbspt && window.hbspt.forms) {
        window.hbspt.forms.create({
          region: "na1",
          portalId: "47533335",
          formId: "655271df-bc7e-49ac-b47a-b6fd1dec3eac",
          target: "#hs-form-container"
        });
      }
    });
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const companyInput   = document.getElementById("company-search");
      const companyResults = document.getElementById("company-results");
      const companySelected = document.getElementById("company-selected");

      const contactInput   = document.getElementById("contact-search");
      const contactResults = document.getElementById("contact-results");

      if (!companyInput || !companyResults || !companySelected || !contactInput || !contactResults) {
        console.warn("Search inputs or result containers not found in DOM.");
        return;
      }

      let selectedCompanies = [];

      function debounce(fn, delay) {
        let t;
        return function (...args) {
          clearTimeout(t);
          t = setTimeout(() => fn.apply(this, args), delay);
        };
      }

      // -----------------------------
      // COMPANY SEARCH (multi-select)
      // -----------------------------
      companyInput.addEventListener(
        "input",
        debounce(async () => {
          const q = companyInput.value.trim();
          companyResults.innerHTML = "";
          if (!q) return;

          try {
            const res = await fetch(
              "/.netlify/functions/searchCompanies?q=" + encodeURIComponent(q)
            );
            if (!res.ok) return;

            const data = await res.json();
            (data.companies || []).forEach((c) => {
              const li = document.createElement("li");
              const parts = [c.name];
              if (c.city) parts.push(`(${c.city})`);
              if (c.domain) parts.push(`– ${c.domain}`);
              li.textContent = parts.join(" ");
              li.dataset.id = c.id;
              li.dataset.name = c.name;
              li.dataset.city = c.city || "";
              li.dataset.domain = c.domain || "";
              companyResults.appendChild(li);
            });
          } catch (e) {
            console.error("Company search error:", e);
          }
        }, 300)
      );

      companyResults.addEventListener("click", (e) => {
        if (e.target.tagName !== "LI") return;

        const id     = e.target.dataset.id;
        const name   = e.target.dataset.name;
        const city   = e.target.dataset.city;
        const domain = e.target.dataset.domain;

        if (!selectedCompanies.find((c) => c.id === id)) {
          selectedCompanies.push({ id, name, city, domain });
          renderSelectedCompanies();
          syncCompaniesToForm();
        }

        companyInput.value = "";
        companyResults.innerHTML = "";
      });

      function renderSelectedCompanies() {
        companySelected.innerHTML = "";
        selectedCompanies.forEach((c) => {
          const chip = document.createElement("div");
          chip.className = "chip";
          chip.textContent = c.name;

          const btn = document.createElement("button");
          btn.type = "button";
          btn.textContent = "×";
          btn.addEventListener("click", () => {
            selectedCompanies = selectedCompanies.filter((x) => x.id !== c.id);
            renderSelectedCompanies();
            syncCompaniesToForm();
          });

          chip.appendChild(btn);
          companySelected.appendChild(chip);
        });
      }

      function syncCompaniesToForm() {
        const ids   = selectedCompanies.map((c) => c.id);
        const names = selectedCompanies.map((c) => c.name);

        syncToHubSpotField("associated_company_ids_multi", ids.join(","));
        syncToHubSpotField("associated_company_names_multi", names.join(", "));

        if (selectedCompanies.length > 0) {
          syncToHubSpotField("associated_company", selectedCompanies[0].name);
          syncToHubSpotField("associated_company_id", selectedCompanies[0].id);
        } else {
          syncToHubSpotField("associated_company", "");
          syncToHubSpotField("associated_company_id", "");
        }

        syncToHubSpotField("receipt_split", String(selectedCompanies.length || 0));
      }

      // -----------------------------
      // CONTACT SEARCH (single)
      // -----------------------------
      contactInput.addEventListener(
        "input",
        debounce(async () => {
          const q = contactInput.value.trim();
          contactResults.innerHTML = "";
          if (!q) return;

          try {
            const res = await fetch(
              "/.netlify/functions/searchContacts?q=" + encodeURIComponent(q)
            );
            if (!res.ok) return;

            const data = await res.json();
            (data.contacts || []).forEach((c) => {
              const li = document.createElement("li");
              const fullName = [c.firstname, c.lastname].filter(Boolean).join(" ");
              const label = fullName ? `${fullName} <${c.email}>` : c.email;
              li.textContent = label;
              li.dataset.id = c.id;
              li.dataset.name = fullName || c.email;
              li.dataset.email = c.email;
              contactResults.appendChild(li);
            });
          } catch (e) {
            console.error("Contact search error:", e);
          }
        }, 300)
      );

      contactResults.addEventListener("click", (e) => {
        if (e.target.tagName !== "LI") return;

        const name  = e.target.dataset.name;
        const email = e.target.dataset.email;
        const id    = e.target.dataset.id;

        contactInput.value = name ? `${name} <${email}>` : email;
        contactResults.innerHTML = "";

        syncToHubSpotField("associated_contact", name || email || "");
        syncToHubSpotField("associated_contact_id", id || "");
      });

      // -----------------------------
      // Helper: sync into HubSpot form fields
      // -----------------------------
      function syncToHubSpotField(internalName, value) {
        const start = Date.now();
        const maxMs = 5000;

        const interval = setInterval(() => {
          const field = document.querySelector(
            '.hs-form input[name="' + internalName + '"]'
          );

          if (field) {
            field.value = value;
            const evt = new Event("input", { bubbles: true });
            field.dispatchEvent(evt);
            clearInterval(interval);
          } else if (Date.now() - start > maxMs) {
            clearInterval(interval);
          }
        }, 300);
      }
    });
  </script>
</body>
</html>
